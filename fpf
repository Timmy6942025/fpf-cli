#!/usr/bin/env bash

set -euo pipefail

resolve_script_path() {
    local source_path="$1"
    local source_dir=""
    local link_target=""

    while [[ -h "${source_path}" ]]; do
        source_dir="$(cd -P "$(dirname "${source_path}")" && pwd)"
        link_target="$(readlink "${source_path}")"
        if [[ "${link_target}" == /* ]]; then
            source_path="${link_target}"
        else
            source_path="${source_dir}/${link_target}"
        fi
    done

    source_dir="$(cd -P "$(dirname "${source_path}")" && pwd)"
    printf "%s/%s" "${source_dir}" "$(basename "${source_path}")"
}

main() {
    local script_path=""
    local script_dir=""
    local uname_s=""
    local uname_m=""
    local goos=""
    local goarch=""
    local candidate=""

    script_path="$(resolve_script_path "${BASH_SOURCE[0]}")"
    script_dir="$(cd -P "$(dirname "${script_path}")" && pwd)"
    if [[ "${FPF_SKIP_GO_BOOTSTRAP:-0}" == "1" ]]; then
        case "${OSTYPE:-}" in
            linux*)
                uname_s="Linux"
                ;;
            darwin*)
                uname_s="Darwin"
                ;;
            msys*|cygwin*|win32*)
                uname_s="MINGW"
                ;;
            *)
                uname_s="$(uname -s 2>/dev/null || true)"
                ;;
        esac

        case "${HOSTTYPE:-${MACHTYPE:-}}" in
            *x86_64*|*amd64*)
                uname_m="x86_64"
                ;;
            *aarch64*|*arm64*)
                uname_m="arm64"
                ;;
            *)
                uname_m="$(uname -m 2>/dev/null || true)"
                ;;
        esac
    else
        uname_s="$(uname -s 2>/dev/null || true)"
        uname_m="$(uname -m 2>/dev/null || true)"
    fi

    case "${uname_s}" in
        Linux)
            goos="linux"
            ;;
        Darwin)
            goos="darwin"
            ;;
        MINGW*|MSYS*|CYGWIN*)
            goos="windows"
            ;;
        *)
            printf "fpf: unsupported OS '%s'\n" "${uname_s}" >&2
            exit 1
            ;;
    esac

    case "${uname_m}" in
        x86_64|amd64)
            goarch="amd64"
            ;;
        arm64|aarch64)
            goarch="arm64"
            ;;
        *)
            goarch=""
            ;;
    esac

    if [[ -n "${goarch}" ]]; then
        candidate="${script_dir}/bin/fpf-go-${goos}-${goarch}"
        if [[ "${goos}" == "windows" ]]; then
            candidate="${candidate}.exe"
        fi
        if [[ -x "${candidate}" ]]; then
            export FPF_PACKAGE_JSON="${script_dir}/package.json"
            exec "${candidate}" "$@"
        fi
    fi

    for goarch in amd64 arm64; do
        candidate="${script_dir}/bin/fpf-go-${goos}-${goarch}"
        if [[ "${goos}" == "windows" ]]; then
            candidate="${candidate}.exe"
        fi
        if [[ -x "${candidate}" ]]; then
            export FPF_PACKAGE_JSON="${script_dir}/package.json"
            exec "${candidate}" "$@"
        fi
    done

    printf "fpf: missing packaged Go binary for %s/%s\n" "${goos}" "${uname_m}" >&2
    printf "fpf: expected one of:\n" >&2
    printf "  %s/bin/fpf-go-%s-amd64\n" "${script_dir}" "${goos}" >&2
    printf "  %s/bin/fpf-go-%s-arm64\n" "${script_dir}" "${goos}" >&2
    if [[ "${goos}" == "windows" ]]; then
        printf "  (with .exe suffix on Windows binaries)\n" >&2
    fi
    printf "fpf: run 'bash scripts/build-go-binaries.sh' to build local binaries.\n" >&2
    exit 1

}

main "$@"
